{% extends 'base.html' %}

{% block body_id %}detail-zaka-page{% endblock %}
{% block title %}Detail ≈æ√°ka{% endblock %}

{% block content %}
<h1>Detail ≈æ√°ka</h1>

<div class="header-container">
    <div class="student-info-wrapper">
        <table class="student-info-table">
            <tr>
                <th>Jm√©no</th>
                <td>{{ zak.jmeno }}</td>
            </tr>
            <tr>
                <th>P≈ô√≠jmen√≠</th>
                <td>{{ zak.prijmeni }}</td>
            </tr>
            <tr>
                <th>T≈ô√≠da (aktu√°ln√≠)</th>
                <td id="aktualni-trida">
                    {% if zak.cislo_tridy and zak.pismeno_tridy %}
                        {{ zak.cislo_tridy }}.{{ zak.pismeno_tridy }}
                    {% else %}
                        Absolvent
                    {% endif %}
                </td>
            </tr>             
            <tr>
                <th>≈†koln√≠ rok odchodu</th>
                <td>{{ zak.get_skolni_rok_odchodu() }}</td>
            </tr>                                         
                <th>Pohlav√≠</th>
                <td>{{ zak.pohlavi }}</td>
            </tr>
        </table>        

        <div class="logo-container">
            {% if zak.pohlavi|lower == "d√≠vka" %}
                <img src="{{ url_for('static', filename='logo_zlepseni_divka.jpg') }}" alt="Logo d√≠vka" class="student-logo">
            {% else %}
                <img src="{{ url_for('static', filename='logo_zlepseni_chlapec.jpg') }}" alt="Logo chlapec" class="student-logo">
            {% endif %}
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let ulozenyRok = localStorage.getItem("skolniRok");
        if (ulozenyRok) {
            document.getElementById("skolni-rok-text").innerText = ulozenyRok;

            fetch(`/ziskat_tridu?zak_id={{ zak.id }}&rok=${ulozenyRok}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const aktualniTridaElement = document.getElementById("aktualni-trida");
                        if (aktualniTridaElement) {
                            aktualniTridaElement.innerText = data.trida;
                        }
                    }
                })
                .catch(error => console.error("‚ùå Chyba p≈ôi z√≠sk√°v√°n√≠ t≈ô√≠dy:", error));
        }
    });
</script>

<!-- St≈ôedn√≠ blok: Tabulka Hodnocen√≠ -->
<div class="center-section">
    {% if zak.pohlavi|lower == "chlapec" %}
    <h2 class="grading-table-h2">Hodnocen√≠ - chlapci</h2>
    <table class="grading-table chlapec">
    {% else %}
    <h2 class="grading-table-h2">Hodnocen√≠ - d√≠vky</h2>
    <table class="grading-table divka">
    {% endif %}
      <tr>
        <th>Zn√°mka</th>
        <th>Rozmez√≠ bod≈Ø - pr≈Ømƒõr</th>
      </tr>
      <tr>
        <td>1</td>
        <td id="range_1">{{ bodove_rozmezi[1] }}</td>
      </tr>
      <tr>
        <td>2</td>
        <td id="range_2">{{ bodove_rozmezi[2] }}</td>
      </tr>
      <tr>
        <td>3</td>
        <td id="range_3">{{ bodove_rozmezi[3] }}</td>
      </tr>
      <tr>
        <td>4</td>
        <td id="range_4">{{ bodove_rozmezi[4] }}</td>
      </tr>
    </table>
</div>
    
<!-- Prav√Ω blok: Info-boxy -->
<div class="right-section">
  <div class="info-box points-box" id="totalPoints">Body: 0</div>
  <div class="info-box average-box" id="averagePoints">Pr≈Ømƒõr: 0</div>
  <div class="info-box grade-box" id="finalGrade">Zn√°mka: -</div>
  <div class="info-box discipline-count-box" id="completedDisciplines">Poƒçet zapsan√Ωch discipl√≠n: 0</div>
</div>

<form id="vykonForm">
    <input type="hidden" id="selectedRocnik" name="rocnik" value="6">
    <input type="hidden" name="zak_id" value="{{ zak.id }}">

<!-- Obal pro cel√Ω blok v√Ωsledk≈Ø v√Ωkon≈Ø -->
<div class="performance-section">
    <h2 class="discipline-table-h2">V√Ωsledky v√Ωkon≈Ø</h2>
    <table class="discipline-table {% if zak.pohlavi|lower == 'chlapec' %}chlapec{% else %}divka{% endif %}">
        <thead>
            <tr>
                <th>Discipl√≠na</th>
                <th>V√Ωkon</th>
                <th>Jednotka</th>
                <th>N√°povƒõda</th>
                <th>Body</th>
            </tr>
        </thead>
        <tbody>
            {% for disciplina in disciplines %}
            {% if disciplina.nazev not in ["Refer√°t", "Reprezentace ≈°koly", "No≈°en√≠ cviƒçebn√≠ho √∫boru", "Veden√≠ rozcviƒçky", "Mimo≈°koln√≠ aktivita (nap≈ô. screenshot aplikace sleduj√≠c√≠ aktivitu)", "Aktivn√≠ p≈ô√≠stup, snaha", "Zlep≈°en√≠ v√Ωkonu od posledn√≠ho mƒõ≈ôen√≠", "Pomoc s organizac√≠", "Ostatn√≠ plusov√© body", "Neno≈°en√≠ cviƒçebn√≠ho √∫boru", "Bezpeƒçnostn√≠ riziko (gumiƒçka, boty, ‚Ä¶)", "Nek√°ze≈à (ru≈°en√≠, neperespektov√°n√≠ pokyn≈Ø, ‚Ä¶)", "Ostatn√≠ m√≠nusov√© body"] %}
            <tr>
                <td>{{ disciplina.nazev }}</td>
                <td>
                    <input 
                        type="text" 
                        name="vykon_{{ disciplina.id }}" 
                        id="vykon_{{ disciplina.id }}" 
                        value="{{ vykon.hodnota if vykon else '' }}"
                        data-id="{{ disciplina.id }}"
                        data-typ="disciplina"
                        inputmode="decimal"
                        pattern="[0-9]*[.,]?[0-9]*"
                    >
                </td>
                <td>{{ disciplina.jednotka or 'N/A' }}</td>
                <td>{{ disciplina.napoveda or 'Nen√≠ k dispozici' }}</td>
                <td id="body_{{ disciplina.id }}" class="body-cell" data-body-id="{{ disciplina.id }}">0</td>
            </tr>            
            {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Obal pro bonusov√© body -->
<div class="bonus-section">
    <h2 class="bonus-table-h2">Bonusov√© body</h2>
    <table class="bonus-table">
        <tr>
            <th>Discipl√≠na</th>
            <th>V√Ωkon</th>
            <th>Jednotka</th>
            <th>N√°povƒõda</th>
            <th>Body</th>
        </tr>
        {% for disciplina in disciplines %}
        {% if disciplina.nazev in ["Refer√°t", "Reprezentace ≈°koly", "No≈°en√≠ cviƒçebn√≠ho √∫boru", "Veden√≠ rozcviƒçky", "Mimo≈°koln√≠ aktivita (nap≈ô. screenshot aplikace sleduj√≠c√≠ aktivitu)", "Aktivn√≠ p≈ô√≠stup, snaha", "Zlep≈°en√≠ v√Ωkonu od posledn√≠ho mƒõ≈ôen√≠", "Pomoc s organizac√≠", "Ostatn√≠ plusov√© body"] %}
        <tr>
            <td>{{ disciplina.nazev }}</td>
            <td>
                <input 
                    type="text" 
                    name="vykon_{{ disciplina.id }}" 
                    id="vykon_{{ disciplina.id }}" 
                    value="{{ vykon.hodnota if vykon else '' }}"
                    data-id="{{ disciplina.id }}"
                    data-typ="bonus"
                    inputmode="decimal"
                    pattern="\d+"
                    oninput="formatAndCalculate(this, '{{ disciplina.id }}')"
                >
            </td>
            <td>{{ disciplina.jednotka or 'N/A' }}</td>
            <td>{{ disciplina.napoveda or 'Nen√≠ k dispozici' }}</td>
            <td id="body_{{ disciplina.id }}" class="body-cell" data-body-id="{{ disciplina.id }}">0</td>
        </tr>            
        {% endif %}
        {% endfor %}
    </table>
</div>

<!-- Obal pro penalizaƒçn√≠ body -->
<div class="penalty-section">
    <h2 class="penalty-table-h2">Penalizaƒçn√≠ body</h2>
    <table class="penalty-table">
        <tr>
            <th>Discipl√≠na</th>
            <th>V√Ωkon</th>
            <th>Jednotka</th>
            <th>N√°povƒõda</th>
            <th>Body</th>
        </tr>
        {% for disciplina in disciplines %}
        {% if disciplina.nazev in ["Neno≈°en√≠ cviƒçebn√≠ho √∫boru", "Bezpeƒçnostn√≠ riziko (gumiƒçka, boty, ‚Ä¶)", "Nek√°ze≈à (ru≈°en√≠, neperespektov√°n√≠ pokyn≈Ø, ‚Ä¶)", "Ostatn√≠ m√≠nusov√© body"] %}
        <tr>
            <td>{{ disciplina.nazev }}</td>
            <td>
                <input 
                    type="text" 
                    name="vykon_{{ disciplina.id }}" 
                    id="vykon{{ disciplina.id }}" 
                    value="{{ vykon.hodnota if vykon else '' }}"
                    data-id="{{ disciplina.id }}"
                    data-typ="penalty"
                    inputmode="decimal"
                    pattern="\d+"
                    oninput="formatAndCalculate(this, '{{ disciplina.id }}')"
                >
            </td>
            <td>{{ disciplina.jednotka or 'N/A' }}</td>
            <td>{{ disciplina.napoveda or 'Nen√≠ k dispozici' }}</td>
            <td id="body_{{ disciplina.id }}" class="body-cell" data-body-id="{{ disciplina.id }}">0</td>
        </tr>            
        {% endif %}
        {% endfor %}
    </table>
</div>

<p id="responseMessage"></p>

<!-- Hlavn√≠ JavaScript -->
<script>
    // Pomocn√© funkce pro form√°tov√°n√≠ a v√Ωpoƒçet bod≈Ø
    function formatAndCalculate(input, disciplinaId) {
        let value = input.value.trim();

        if (value.match(/^\d{1,2}:\d{2}$/)) {
            let parts = value.split(":"), minuty = parseInt(parts[0], 10), sekundy = parseInt(parts[1], 10);
            input.value = `${minuty}:${sekundy.toString().padStart(2, '0')}`;
        }

        calculatePoints(input, disciplinaId);
    }

    async function calculatePoints(input, disciplinaId) {
        let vykon = input.value.trim();
        if (!vykon) return;

        try {
            let response = await fetch("/ziskat_body", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ vykon: vykon, discipline_id: disciplinaId })
            });
            let data = await response.json();
            let bodyCell = document.getElementById("body_" + disciplinaId);
            if (!response.ok || data.error) {
                bodyCell.innerText = "‚ùå Chyba!";
                bodyCell.classList.add("chyba");
            } else {
                bodyCell.innerText = data.body;
                bodyCell.classList.remove("chyba");
            }
        } catch (error) {
            console.error("Chyba p≈ôi z√≠sk√°v√°n√≠ bod≈Ø:", error);
            document.getElementById("body_" + disciplinaId).innerText = "‚ùå Chyba!";
        }
    }

    async function submitPerformances() {
        let formData = new FormData(document.getElementById("vykonForm"));
        let data = {};

        formData.forEach((value, key) => {
            data[key] = value.trim(); // Odebr√°n√≠ mezer
        });

        try {
            let response = await fetch("/ulozit_vykony", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            let result = await response.json();
            if (result.success) {
                document.getElementById("responseMessage").innerText = "‚úÖ V√Ωkony ulo≈æeny!";
                
                // Po ulo≈æen√≠ aktualizujeme hodnoty v tabulce
                nactiVykony(document.getElementById("selectedRocnik").value);
            } else {
                document.getElementById("responseMessage").innerText = "‚ùå Chyba p≈ôi ukl√°d√°n√≠ v√Ωkon≈Ø!";
            }
        } catch (error) {
            console.error("Chyba p≈ôi ukl√°d√°n√≠ v√Ωkon≈Ø:", error);
        }
    }
    
    // Hlavn√≠ funkce pro naƒç√≠t√°n√≠ v√Ωkon≈Ø
    async function nactiVykony(rocnik) {
        const zakId = document.querySelector("[name='zak_id']").value;
        console.log(`üîç Naƒç√≠t√°m v√Ωkony pro ≈æ√°ka ${zakId}, roƒçn√≠k ${rocnik}`);
    
        // Vyƒçi≈°tƒõn√≠ st√°vaj√≠c√≠ch hodnot
        document.querySelectorAll("[name^='vykon_']").forEach(input => {
            input.value = "";
        });
        document.querySelectorAll("[id^='body_']").forEach(cell => {
            cell.innerText = "0";
            cell.classList.remove("error");
        });
    
        try {
            const response = await fetch(`/nacti_vykony?zak_id=${zakId}&rocnik=${rocnik}`);
            const data = await response.json();
    
            if (data.success) {
                console.log(`‚úÖ Naƒçteno ${data.vykony.length} v√Ωkon≈Ø`);
                
                data.vykony.forEach(vykon => {
                    const vykonInput = document.querySelector(`[name='vykon_${vykon.discipline_id}']`);
                    const bodyCell = document.getElementById(`body_${vykon.discipline_id}`);
    
                    if (vykonInput) {
                        vykonInput.value = vykon.vykon;
                    }
                    if (bodyCell) {
                        bodyCell.innerText = vykon.body;
                    }
                });
                
                // Aktualizace souhrnn√Ωch informac√≠
                setTimeout(() => {
                    updateTotalPointsAndGrade();
                    updateCompletedDisciplines();
                }, 100);
            } else {
                console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ v√Ωkon≈Ø: ${data.error}`);
            }
        } catch (error) {
            console.error(`‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ v√Ωkon≈Ø: ${error}`);
        }
    }
    
    // Funkce pro zmƒõnu roƒçn√≠ku
    function zmenRocnik() {
        const vybranyRocnik = document.getElementById("selectedRocnik").value;
        
        // Resetov√°n√≠ informac√≠ p≈ôed naƒçten√≠m nov√Ωch dat
        document.getElementById("totalPoints").innerText = "Body: 0";
        document.getElementById("averagePoints").innerText = "Pr≈Ømƒõr: 0";
        document.getElementById("finalGrade").innerText = "Zn√°mka: -";
        document.getElementById("completedDisciplines").innerText = "Poƒçet zapsan√Ωch discipl√≠n: 0";
        
        // Naƒçten√≠ v√Ωkon≈Ø pro vybran√Ω roƒçn√≠k
        nactiVykony(vybranyRocnik);
        
        // Aktualizace bodov√Ωch rozmez√≠ pro zn√°mky
        updateGradingTable();
    }
    
    // Funkce pro v√Ωpoƒçet bod≈Ø a zn√°mek
    function updateTotalPointsAndGrade() {
        let totalPoints = 0;
        let totalForAverage = 0;
        let completedDisciplines = 0;
        let bonusPoints = 0;
        let penaltyPoints = 0;
        
        document.querySelectorAll(".body-cell").forEach(cell => {
            const value = parseFloat(cell.innerText) || 0;
            const row = cell.closest("tr");
            const table = row.closest("table");
            
            if (!table) return;
            
            const tableTitle = table.previousElementSibling ? table.previousElementSibling.innerText.trim() : "";
            
            if (tableTitle.includes("V√Ωsledky v√Ωkon≈Ø")) {
                if (value !== 0) {
                    totalPoints += value;
                    totalForAverage += value;
                    completedDisciplines++;
                }
            } else if (tableTitle.includes("Bonusov√© body")) {
                bonusPoints += value;
                totalForAverage += value;
            } else if (tableTitle.includes("Penalizaƒçn√≠ body")) {
                penaltyPoints += value;
                totalForAverage += value;
            }
        });
        
        const totalWithBonusAndPenalty = totalPoints + bonusPoints + penaltyPoints;
        document.getElementById("totalPoints").innerText = `Body: ${totalWithBonusAndPenalty}`;
        
        const averagePoints = completedDisciplines > 0 ? Math.round(totalForAverage / completedDisciplines) : 0;
        document.getElementById("averagePoints").innerText = `Pr≈Ømƒõr: ${averagePoints}`;
        
        const rocnikElement = document.getElementById("selectedRocnik");
        const rocnik = rocnikElement ? parseInt(rocnikElement.value) : 0;
        const zakPohlavi = document.querySelector("[name='zak_pohlavi']")?.value || "{{ zak.pohlavi }}".toLowerCase();
        const baseReference = zakPohlavi.includes("chlapec") ? 130 : 110;
        const referenceValue = baseReference * Math.pow(0.9, (9 - rocnik));
        
        // Z√≠sk√°n√≠ mez√≠ pro zn√°mky z tabulky hodnocen√≠
        const grade1Min = parseInt(document.getElementById("range_1")?.innerText.split(" - ")[0]) || 0;
        const grade2Min = parseInt(document.getElementById("range_2")?.innerText.split(" - ")[0]) || 0;
        const grade3Min = parseInt(document.getElementById("range_3")?.innerText.split(" - ")[0]) || 0;
        
        // Opraven√° logika zn√°mkov√°n√≠ podle tabulky
        let grade = "-";
        if (completedDisciplines > 0) {
            if (averagePoints >= grade1Min) {
                grade = "1";
            } else if (averagePoints >= grade2Min) {
                grade = "2";
            } else if (averagePoints >= grade3Min) {
                grade = "3";
            } else if (averagePoints >= 20) {
                grade = "4";
            } else {
                grade = "5";
            }
        }
        
        document.getElementById("finalGrade").innerText = `Zn√°mka: ${grade}`;
    }
    
    // Funkce pro aktualizaci poƒçtu splnƒõn√Ωch discipl√≠n
    function updateCompletedDisciplines() {
        let count = 0;
        document.querySelectorAll(".discipline-table input").forEach(input => {
            if (input.value.trim() !== "") {
                count++;
            }
        });
        document.getElementById("completedDisciplines").innerText = `Poƒçet zapsan√Ωch discipl√≠n: ${count}`;
    }
    
    // Funkce pro aktualizaci tabulky hodnocen√≠
    function updateGradingTable() {
        const rocnik = parseInt(document.getElementById("selectedRocnik").value);
        const zakPohlavi = document.querySelector("[name='zak_pohlavi']")?.value || "{{ zak.pohlavi }}".toLowerCase();
        
        const baseReference = zakPohlavi.includes("chlapec") ? 130 : 110;
        const referenceValue = baseReference * Math.pow(0.9, (9 - rocnik));
        
        const gradeRanges = {
            1: `${Math.round(referenceValue * 1.0)} - 200`,
            2: `${Math.round(referenceValue * 0.9)} - ${Math.round(referenceValue * 1.0) - 1}`,
            3: `${Math.round(referenceValue * 0.8)} - ${Math.round(referenceValue * 0.9) - 1}`,
            4: `20 - ${Math.round(referenceValue * 0.8) - 1}`
        };
        
        for (let i = 1; i <= 4; i++) {
            const rangeElement = document.getElementById(`range_${i}`);
            if (rangeElement) {
                rangeElement.innerText = gradeRanges[i];
            }
        }
    }
    
    // Inicializace po naƒçten√≠ str√°nky
    document.addEventListener("DOMContentLoaded", function() {
        // P≈ôid√°n√≠ hidden pole pro pohlav√≠, pokud neexistuje
        if (!document.querySelector("[name='zak_pohlavi']")) {
            const pohlavi = "{{ zak.pohlavi }}";
            const pohlaviInput = document.createElement("input");
            pohlaviInput.type = "hidden";
            pohlaviInput.name = "zak_pohlavi";
            pohlaviInput.value = pohlavi;
            document.getElementById("vykonForm").appendChild(pohlaviInput);
        }
        
        // P≈ôid√°n√≠ event listener≈Ø pro automatick√© ukl√°d√°n√≠
        document.querySelectorAll("[name^='vykon_']").forEach(input => {
            // Automatick√© ukl√°d√°n√≠ p≈ôi ztr√°tƒõ fokusu
            input.addEventListener("blur", async function() {
                const disciplinaId = this.dataset.id || this.name.split("_")[1];
                const vykon = this.value.trim();
                const zakId = document.querySelector("[name='zak_id']").value;
                const rocnik = document.getElementById("selectedRocnik").value;
                const bodyCell = document.getElementById("body_" + disciplinaId);
                
                // Pokud je v√Ωkon pr√°zdn√Ω, nastav√≠me body na "0"
                if (vykon === "") {
                    bodyCell.innerText = "0";
                    updateTotalPointsAndGrade();
                    updateCompletedDisciplines();
                    return;
                }
                
                console.log(`üîÑ Ukl√°d√°m v√Ωkon: ≈æ√°k=${zakId}, discipl√≠na=${disciplinaId}, roƒçn√≠k=${rocnik}, hodnota=${vykon}`);
                
                try {
                    const response = await fetch("/ulozit_vykon", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            zak_id: zakId,
                            discipline_id: disciplinaId,
                            rocnik: rocnik,
                            vykon: vykon
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        bodyCell.innerText = result.body;
                        console.log(`‚úÖ V√Ωkon byl √∫spƒõ≈°nƒõ ulo≈æen: ${result.body} bod≈Ø`);
                    } else {
                        console.error(`‚ùå Chyba p≈ôi ukl√°d√°n√≠ v√Ωkonu: ${result.error}`);
                        bodyCell.innerText = "Chyba";
                        bodyCell.classList.add("error");
                    }
                } catch (error) {
                    console.error(`‚ùå Chyba p≈ôi ukl√°d√°n√≠ v√Ωkonu: ${error}`);
                    bodyCell.innerText = "Chyba";
                    bodyCell.classList.add("error");
                }
                
                // Aktualizace souhrnn√Ωch informac√≠ po ulo≈æen√≠
                setTimeout(() => {
                    updateTotalPointsAndGrade();
                    updateCompletedDisciplines();
                }, 100);
            });
            
            // Automatick√© ukl√°d√°n√≠ p≈ôi stisknut√≠ Enter
            input.addEventListener("keydown", function(event) {
                if (event.key === "Enter") {
                    this.blur(); // Ztrat√≠ fokus, co≈æ aktivuje ud√°lost blur
                }
            });
            
            // Sledov√°n√≠ zmƒõn pro aktualizaci poƒçtu discipl√≠n
            input.addEventListener("input", updateCompletedDisciplines);
        });
        
        // Inicializace - naƒç√≠st v√Ωkony podle aktu√°ln√≠ho roƒçn√≠ku
        const vybranyRocnik = document.getElementById("selectedRocnik").value;
        nactiVykony(vybranyRocnik);
        
        // Spu≈°tƒõn√≠ aktualizac√≠ hned po naƒçten√≠
        updateGradingTable();
        setTimeout(() => {
            updateTotalPointsAndGrade();
            updateCompletedDisciplines();
        }, 500);
    });
</script>
{% endblock %}